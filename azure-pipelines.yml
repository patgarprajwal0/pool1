trigger:
  - main

variables:
  pythonVersion: '3.11.4'
  artifactName: 'drop'

stages:
  - stage: Build_and_Test
    displayName: 'Build & Test'
    jobs:
      - job: Build
        displayName: 'Build on local agent (pool1)'
        pool:
          name: 'pool1'
          demands:
            - agent.os -equals Windows_NT
            

        steps:
          - checkout: self

          - script: |
              Write-Host "***** Check Python (system) *****"
              python --version
              python -m pip --version
            displayName: 'Check Python on agent'
            shell: powershell

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'
            shell: powershell

          - script: |
              if (Test-Path test-results) { Remove-Item -Recurse -Force test-results }
              New-Item -ItemType Directory -Path test-results | Out-Null
              pytest -q tests --junitxml=test-results/pytest-results.xml
              exit $LASTEXITCODE
            displayName: 'Run tests (pytest)'
            shell: powershell

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/pytest-results.xml'
              testRunTitle: 'PyTest Results'

          - script: |
              Write-Host "***** Stage files for artifact (PowerShell safe for spaces) *****"
              $dst = "$(Build.ArtifactStagingDirectory)"
              Write-Host "Artifact staging directory is: $dst"

              if (-not (Test-Path -Path $dst)) {
                Write-Host "Creating artifact directory..."
                New-Item -ItemType Directory -Path $dst | Out-Null
              }

              $files = @("app.py", "requirements.txt", "runtime.txt", "Procfile")
              foreach ($f in $files) {
                if (Test-Path -Path $f) {
                  Write-Host "Copying $f → $dst"
                  Copy-Item -Path $f -Destination $dst -Force
                } else {
                  Write-Host "Warning: $f not found — skipping"
                }
              }

              Write-Host "`nFinal contents of $dst:"
              Get-ChildItem -Recurse -Path $dst | ForEach-Object { Write-Host $_.FullName }
            displayName: 'Stage files for artifact (PowerShell)'
            shell: powershell

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
              artifactName: '$(artifactName)'
